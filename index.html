<!-- è²·å–ä»•å…¥ã‚Œè¨ˆç®—ãƒ„ãƒ¼ãƒ« v3.74ï¼ˆä¼šå“¡ï¼šè¡¨ç¤ºï¼†è¨ˆç®—å¾®ä¿®æ­£ï¼å¤ªæ ãƒ»å‰²å¼•é¡åˆç®—ãƒ»ãƒ©ãƒ™ãƒ«æ›´æ–°ï¼‰ -->
<div style="all: initial; display:block; width:100%;"><div style="all: revert; writing-mode: horizontal-tb;">
  <style>
    .buyback-tool{--bg:#fff;--ink:#111;--muted:#666;--ok:#0a7a32;--bad:#b00020;--card:#f7f7f8;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif;
      color:var(--ink); background:var(--bg); max-width:900px; margin:18px auto; padding:16px;}
    .bb-card{background:var(--card); border-radius:16px; box-shadow:0 2px 10px rgba(0,0,0,.06); padding:18px; margin:12px 0;}
    .bb-row{display:grid; grid-template-columns:1fr 180px; gap:12px; align-items:end;}
    .bb-row + .bb-row{margin-top:12px;}
    .bb-row-jan{grid-template-columns:1fr 180px;}
    .bb-label{font-size:12px; color:var(--muted); margin-bottom:6px;}
    .bb-input,.bb-select{width:100%; font-size:20px; padding:10px 12px; border-radius:12px; border:1px solid #ddd; background:#fff;}
    .bb-input.emph{border:2px solid #333;} /* å¤ªæ ï¼ˆå¼·èª¿ï¼‰ */
    .bb-input.jan{font-variant-numeric:tabular-nums; letter-spacing:.02em;}
    .bb-select{appearance:none; background-image:linear-gradient(45deg,transparent 50%,#999 50%),linear-gradient(135deg,#999 50%,transparent 50%);
      background-position:calc(100% - 18px) 52%, calc(100% - 12px) 52%; background-size:6px 6px,6px 6px; background-repeat:no-repeat;}
    .bb-grid{display:grid; grid-template-columns:repeat(2,1fr); gap:12px; margin-top:12px;}
    .bb-pill{background:#fff; border:1px dashed #ccc; border-radius:12px; padding:10px 12px; text-align:center;}
    .price-big{font-size:36px; font-weight:800; letter-spacing:.02em;}
    .profit{font-size:28px; font-weight:800;} .profit.ok{color:var(--ok);} .profit.bad{color:var(--bad);}
    .hint{font-size:12px; color:var(--muted);}
    .profit-wrap{display:flex; align-items:center; gap:8px;}
    .bb-btn{font-size:13px; padding:8px 12px; border-radius:10px; border:1px solid #ccc; background:#fff; cursor:pointer;}
    .bb-btn:active{transform:translateY(1px);}
    .push-right{margin-left:auto;}
    .bb-input-group{display:flex; gap:8px; align-items:center;}
    .bb-input-group .bb-input{flex:1 1 auto;}
    .bb-btn.clear{white-space:nowrap; padding:8px 10px;}

    .bb-links{display:flex; flex-wrap:wrap; gap:10px; margin-top:10px;}
    .bb-linkbtn{display:inline-flex; align-items:center; justify-content:center; padding:10px 14px; min-width:110px;
      border-radius:999px; border:1px solid #ddd; background:#fff; text-decoration:none; color:#111; font-weight:700; box-shadow:0 1px 4px rgba(0,0,0,.06);}
    .bb-linkbtn:hover{border-color:#bbb;}
    .bb-linkbtn span{margin-left:6px; font-size:12px; color:#777;}

    .bb-modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.35); z-index:9999;}
    .bb-modal.show{display:flex;}
    .bb-modal-box{background:#fff; max-width:520px; width:90%; border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.2); padding:18px;}
    .bb-modal-title{font-size:20px; font-weight:800; margin:0 0 6px;}
    .bb-modal-body{font-size:14px; color:#666; margin-bottom:14px;}
    .bb-modal-actions{display:flex; gap:10px; justify-content:flex-end;}
    .bb-badge{display:inline-block; font-size:11px; padding:3px 8px; border-radius:999px; background:#eee; color:#555; margin-left:8px;}

    /* ã‚«ãƒ¡ãƒ©ãƒ»ã‚¹ã‚­ãƒ£ãƒŠUIï¼ˆç¶­æŒï¼‰ */
    .scan-wrap{position:fixed; inset:0; background:rgba(0,0,0,.88); z-index:10000; display:none; flex-direction:column; align-items:center; justify-content:center; color:#fff;}
    .scan-wrap.show{display:flex;}
    .scan-box{width:min(92vw,560px);}
    .stage{position:relative; width:100%; padding-top:56.25%; border-radius:12px; overflow:hidden; background:#000; box-shadow:0 10px 30px rgba(0,0,0,.4);}
    #h5Region, .video-host{position:absolute; inset:0; width:100%; height:100%;}
    .stage :where(video,canvas,div){position:absolute; inset:0; width:100%; height:100%; object-fit:cover;}
    .mask{position:absolute; inset:0; pointer-events:none; box-shadow:inset 0 0 0 9999px rgba(0,0,0,.28); z-index:2147483645;}
    .scanline{position:absolute; left:0; width:100%; height:2px;
      background:linear-gradient(90deg,transparent 0,#ff3b30 20%,#ff3b30 80%,transparent 100%); box-shadow:0 0 10px #ff3b30, 0 0 2px #ff3b30;
      will-change:transform; pointer-events:none; z-index:2147483646;}
    .scan-toolbar{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; justify-content:center;}
    .scan-btn{background:#fff; color:#111; border-radius:10px; border:1px solid #ddd; padding:8px 12px; font-weight:700;}
    .scan-msg{margin-top:6px; font-size:12px; opacity:.95; text-align:center; color:#ffd;}
    .scan-hint{margin-top:6px; font-size:12px; opacity:.9; text-align:center;}

    /* Bluetooth HIDãƒ‘ãƒãƒ«ï¼ˆç¶­æŒï¼‰ */
    .hid-wrap{position:fixed; inset:0; background:rgba(0,0,0,.88); z-index:10010; display:none; align-items:center; justify-content:center; color:#fff;}
    .hid-wrap.show{display:flex;}
    .hid-box{width:min(92vw,560px); background:#111; border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.5); padding:16px;}
    .hid-title{font-weight:800; margin:0 0 8px;}
    .hid-display{font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:24px; letter-spacing:.06em; background:#000; color:#0ff; padding:12px; border-radius:10px; min-height:44px;}
    .hid-toolbar{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; justify-content:flex-end;}
    .hid-btn{background:#fff; color:#111; border-radius:10px; border:1px solid #ddd; padding:8px 12px; font-weight:700;}
    .hid-hint{margin-top:6px; font-size:12px; opacity:.9; text-align:left; color:#ffd;}
    .hid-sink{position:absolute; left:-10000px; width:1px; height:1px; opacity:0;}

    #photoInput{position:absolute; left:-9999px; width:1px; height:1px; opacity:0;}

    @media (max-width:680px){
      .bb-row{grid-template-columns:1fr;}
      .bb-row-jan{grid-template-columns:1fr;}
      .bb-grid{grid-template-columns:1fr;}
      .price-big{font-size:30px;}
      .bb-input{font-size:18px;}
    }
  </style>

  <div class="buyback-tool" id="buybackTool">
    <h2 style="margin:0 0 8px 0;">è²·å–ä»•å…¥ã‚Œè¨ˆç®—ãƒ„ãƒ¼ãƒ«ï¼ˆä¼šå“¡ï¼‰</h2>
    <div class="hint">ä»•å…¥ä¾¡æ ¼ã«å‰²å¼•ï¼…ãƒ»ãƒã‚¤ãƒ³ãƒˆãƒ»ã‚¯ãƒ¼ãƒãƒ³ã‚’é©ç”¨ â†’ <strong>å‰²å¼•å¾Œã®ä»•å…¥ã‚Œ</strong>ã‚’ç®—å‡ºã€‚è²·å–ä¾¡æ ¼ã‚’å…¥ã‚Œã‚‹ã¨<strong>åˆ©ç›Š</strong>ã¨<strong>åˆ©ç›Šç‡</strong>ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</div>

    <!-- â–¼â–¼ ã‚¹ã‚¯ã‚·ãƒ§å¯¾è±¡ï¼ˆä»•å…¥ã€œåˆ©ç›Šã‚«ãƒ¼ãƒ‰ï¼‰ â–¼â–¼ -->
    <div id="shotArea">
      <!-- ä»•å…¥ãƒ»å‰²å¼•ãƒ»ãƒã‚¤ãƒ³ãƒˆãƒ»ã‚¯ãƒ¼ãƒãƒ³ -->
      <div class="bb-card">
        <div class="bb-row">
          <div>
            <div class="bb-label">ä»•å…¥ä¾¡æ ¼</div>
            <div class="bb-input-group">
              <input id="priceBase" class="bb-input emph" type="text" inputmode="numeric" placeholder="ä¾‹ï¼‰70,000" value="">
              <button id="clearBase" class="bb-btn clear" type="button">ã‚¯ãƒªã‚¢</button>
            </div>
          </div>
          <div>
            <div class="bb-label">å‰²å¼•ï¼ˆ%OFFï¼‰</div>
            <select id="discountSelect" class="bb-select">
              <option value="0" selected>0%</option>
              <option value="1">1%</option>
              <option value="2">2%</option>
              <option value="3">3%</option>
              <option value="5">5%</option>
              <option value="10">10%</option>
              <option value="15">15%</option>
              <option value="20">20%</option>
              <option value="custom">æ‰‹å…¥åŠ›ï¼ˆä»»æ„ï¼…ï¼‰</option>
            </select>
          </div>
        </div>

        <div class="bb-row" id="customRow" style="display:none;">
          <div>
            <div class="bb-label">ä»»æ„ã®å‰²å¼•ç‡ï¼ˆ%ï¼‰</div>
            <input id="discountCustom" class="bb-input" type="number" inputmode="decimal" step="0.01" placeholder="ä¾‹ï¼‰12.5">
          </div><div></div>
        </div>

        <!-- ãƒã‚¤ãƒ³ãƒˆãƒ»ã‚¯ãƒ¼ãƒãƒ³ï¼ˆå‰²å¼•ã®ä¸‹ï¼æ¨ªä¸¦ã³ï¼‰ -->
        <div class="bb-row">
          <div>
            <div class="bb-label">åˆ©ç”¨ãƒã‚¤ãƒ³ãƒˆ</div>
            <input id="pointsUse" class="bb-input" type="text" inputmode="numeric" placeholder="ä¾‹ï¼‰500">
          </div>
          <div>
            <div class="bb-label">ã‚¯ãƒ¼ãƒãƒ³ï¼ˆå††ï¼‰</div>
            <input id="couponYen" class="bb-input" type="text" inputmode="numeric" placeholder="ä¾‹ï¼‰300">
          </div>
        </div>

        <div class="bb-grid">
          <div class="bb-pill"><div class="bb-label">å‰²å¼•é¡ï¼ˆå‰²å¼•ï¼…ï¼‹ãƒã‚¤ãƒ³ãƒˆï¼‹ã‚¯ãƒ¼ãƒãƒ³ï¼‰</div><div id="offAmount" class="price-big">Â¥0</div></div>
          <div class="bb-pill"><div class="bb-label">å‰²å¼•å¾Œã®ä»•å…¥ã‚Œï¼ˆãƒã‚¤ãƒ³ãƒˆãƒ»ã‚¯ãƒ¼ãƒãƒ³é©ç”¨å¾Œï¼‰</div><div id="priceAfter" class="price-big">Â¥0</div></div>
        </div>
      </div>

      <!-- è²·å–ä¾¡æ ¼ -->
      <div class="bb-card">
        <div class="bb-row">
          <div>
            <div class="bb-label">è²·å–ä¾¡æ ¼ï¼ˆå£²ä¾¡ï¼‰</div>
            <div class="bb-input-group">
              <input id="priceSell" class="bb-input emph" type="text" inputmode="numeric" placeholder="ä¾‹ï¼‰72,000">
              <button id="clearSell" class="bb-btn clear" type="button">ã‚¯ãƒªã‚¢</button>
            </div>
          </div>
          <div>
            <div class="bb-label">&nbsp;</div>
            <div class="profit-wrap">
              <span class="hint">â€»åˆ©ç›Šã¯ä¸‹æ®µã«è¡¨ç¤º</span>
              <button id="resetBtn" class="bb-btn push-right" type="button">ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- â–²â–² ã‚¹ã‚¯ã‚·ãƒ§å¯¾è±¡ã“ã“ã¾ã§ â–²â–² -->

    <!-- â–¼ æœ€ä¸‹éƒ¨ï¼šåˆ©ç›Šè¡¨ç¤ºï¼ˆæ­£å¼è¡¨ç¤ºï¼‹åˆ©ç›Šç‡ï¼‰ -->
    <div class="bb-card">
      <div class="bb-pill" style="background:#fff; border:2px solid #ddd;">
        <div class="bb-label" style="font-size:14px;">åˆ©ç›Šï¼ˆãƒã‚¤ãƒ³ãƒˆãƒ»ã‚¯ãƒ¼ãƒãƒ³é©ç”¨å¾Œï¼‰</div>
        <div id="profitBig" class="price-big">Â¥0</div>
        <div id="profitRate" class="hint" style="margin-top:6px;">åˆ©ç›Šç‡ 0.0%</div>
      </div>
    </div>
    <!-- â–² åˆ©ç›Š -->

    <!-- JANã‚³ãƒ¼ãƒ‰ -->
    <div class="bb-card">
      <div class="bb-row-jan bb-row">
        <div>
          <div class="bb-label">JANã‚³ãƒ¼ãƒ‰</div>
          <div class="bb-input-group">
            <input id="janCode" class="bb-input jan" type="text" inputmode="numeric" pattern="[0-9]{8,14}" placeholder="ä¾‹ï¼‰4948872415910">
            <button id="clearJan" class="bb-btn clear" type="button">ã‚¯ãƒªã‚¢</button>
          </div>
        </div>
        <div>
          <div class="bb-label">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰èª­å–</div>
          <button id="scanStart" class="bb-btn" type="button">ğŸ“· ã‚«ãƒ¡ãƒ©ã§èª­ã¿å–ã‚‹</button>
          <button id="hidStart" class="bb-btn" type="button" style="margin-top:6px;">ğŸ“¶ Bluetoothã‚¹ã‚­ãƒ£ãƒŠå—ä¿¡</button>
          <div class="hint">â€»Bluetoothã‚¹ã‚­ãƒ£ãƒŠã¯HIDï¼ˆã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ï¼‰ãƒ¢ãƒ¼ãƒ‰ã«è¨­å®šã—ã¦ãã ã•ã„ã€‚</div>
        </div>
      </div>
    </div>

    <!-- è²·å–åº—ãƒªãƒ³ã‚¯ï¼ˆJANé€£å‹•ï¼‰ é †ç•ªï¼šå¸‚å ´â†’ãƒ«ãƒ‡ãƒ¤â†’æµ·å³¡â†’å•†åº—â†’ä¸€ä¸ç›® -->
    <div class="bb-card">
      <div class="bb-label">è²·å–åº—ãƒªãƒ³ã‚¯ <span class="bb-badge">JANé€£å‹•</span></div>
      <div class="bb-links">
        <a class="bb-linkbtn" href="https://www.kaden-ichiba.com/item/search/" target="_blank" rel="noopener" data-type="support" data-base="https://www.kaden-ichiba.com/item/search/">å¸‚å ´<span>â†—</span></a>
        <a class="bb-linkbtn" href="https://kaitori-rudeya.com/search/index/" target="_blank" rel="noopener" data-type="support" data-base="https://kaitori-rudeya.com/search/index/">ãƒ«ãƒ‡ãƒ¤<span>â†—</span></a>
        <a class="bb-linkbtn" href="https://www.mobile-ichiban.com/#G01SearchIpt" target="_blank" rel="noopener" data-type="manual" data-name="æµ·å³¡é€šä¿¡">æµ·å³¡<span>â†—</span></a>
        <a class="bb-linkbtn" href="https://www.kaitorishouten-co.jp/" target="_blank" rel="noopener" data-type="manual" data-name="è²·å–å•†åº—">å•†åº—<span>â†—</span></a>
        <a class="bb-linkbtn" href="https://www.1-chome.com/index" target="_blank" rel="noopener" data-type="manual" data-name="ä¸€ä¸ç›®">ä¸€ä¸ç›®<span>â†—</span></a>
      </div>
      <div class="hint">â€»ã€Œæµ·å³¡ï¼å•†åº—ï¼ä¸€ä¸ç›®ã€ã¯ã‚¯ãƒªãƒƒã‚¯æ™‚ã«JANã‚³ãƒ”ãƒ¼æ¡ˆå†…ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</div>
    </div>
  </div>

  <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆJANæ‰‹å‹•ã‚µã‚¤ãƒˆï¼‰ -->
  <div id="janModal" class="bb-modal" aria-hidden="true">
    <div class="bb-modal-box">
      <div class="bb-modal-title" id="modalTitle">ã‚µã‚¤ãƒˆã¸ç§»å‹•</div>
      <div class="bb-modal-body" id="modalBody">ã“ã®ã‚µã‚¤ãƒˆã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªèº«ã§JANã‚’æ¤œç´¢ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</div>
      <div class="bb-modal-actions">
        <button id="modalCopyGo" class="bb-btn">ğŸ“‹ ã‚³ãƒ”ãƒ¼ï¼†ç§»å‹•</button>
        <button id="modalGo" class="bb-btn">â†— ç§»å‹•</button>
        <button id="modalClose" class="bb-btn">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- ã‚«ãƒ¡ãƒ©ã‚¹ã‚­ãƒ£ãƒŠï¼ˆç¶­æŒï¼‰ -->
  <div id="scanWrap" class="scan-wrap" aria-hidden="true">
    <div class="scan-box">
      <div class="stage" id="stage">
        <div id="h5Region"></div>
        <div class="mask"></div>
        <div class="scanline" id="scanLine"></div>
      </div>
      <div class="scan-toolbar">
        <button id="scanStop" class="scan-btn" type="button">åœæ­¢</button>
        <button id="scanClose" class="scan-btn" type="button">é–‰ã˜ã‚‹</button>
        <button id="newtabBtn" class="scan-btn" type="button">ğŸªŸ æ–°è¦ã‚¿ãƒ–ã§ã‚¹ã‚­ãƒ£ãƒ³</button>
        <button id="diagBtn" class="scan-btn" type="button">ğŸ›  ç’°å¢ƒè¨ºæ–­</button>
      </div>
      <div id="scanMsg" class="scan-msg"></div>
      <div class="scan-hint">èµ¤ç·šã‚’ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã«é‡ã­ã¦ãã ã•ã„ï¼ˆä¸­å¤®ä»˜è¿‘ã§ä¸Šä¸‹å¾€å¾©ï¼‰ã€‚</div>
    </div>
  </div>

  <!-- Bluetooth HID å—ä¿¡ãƒ‘ãƒãƒ«ï¼ˆç¶­æŒï¼‰ -->
  <div id="hidWrap" class="hid-wrap" aria-hidden="true">
    <div class="hid-box">
      <h3 class="hid-title">Bluetoothã‚¹ã‚­ãƒ£ãƒŠå—ä¿¡</h3>
      <div id="hidDisplay" class="hid-display"></div>
      <div class="hid-toolbar">
        <button id="hidClear" class="hid-btn" type="button">ã‚¯ãƒªã‚¢</button>
        <button id="hidStop" class="hid-btn" type="button">åœæ­¢</button>
        <button id="hidClose" class="hid-btn" type="button">é–‰ã˜ã‚‹</button>
      </div>
      <div class="hid-hint">ã‚¹ã‚­ãƒ£ãƒŠã®ãƒˆãƒªã‚¬ãƒ¼ã‚’å¼•ã„ã¦ãã ã•ã„ã€‚Enter/Tabã§ç¢ºå®šã€ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ç„¡ã§ã‚‚å…¥åŠ›åœæ­¢ã§è‡ªå‹•ç¢ºå®šã—ã¾ã™ã€‚</div>
      <input id="hidSink" class="hid-sink" type="text" inputmode="numeric" autocomplete="off" autocapitalize="off" spellcheck="false">
    </div>
  </div>

  <!-- ç”»åƒã‹ã‚‰èª­ã¿å–ã‚‹ï¼ˆç¶­æŒï¼‰ -->
  <input id="photoInput" type="file" accept="image/*" capture="environment">
  <div class="bb-card" style="text-align:center;"><label for="photoInput" class="bb-btn">ğŸ“· å†™çœŸã‹ã‚‰èª­ã¿å–ã‚‹</label></div>
  <img id="photoPreview" alt="" style="display:none;"/>

  <!-- åŠ¹æœéŸ³ -->
  <audio id="beep" preload="auto"
    src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAAAgP8AAP8AgICAAAD/AP8A/wAAAP8A/wCAgIAAAAD/AP8A"></audio>

  <script>
  (function(){
    const $=id=>document.getElementById(id);
    const inIframe = (function(){ try{ return window.self !== window.top; }catch(_){ return true; } })();
    function loadScriptChain(urls){ return new Promise((res,rej)=>{ (function n(i){ if(i>=urls.length) return rej(); const s=document.createElement("script"); s.src=urls[i]; s.onload=()=>res(urls[i]); s.onerror=()=>n(i+1); document.head.appendChild(s); })(0); }); }

    /* 3æ¡ã‚«ãƒ³ãƒå…¥åŠ› */
    function fmtInput(el){
      const raw=(el.value||"").replace(/[^\d]/g,"");
      if(raw===""){ el.value=""; return; }
      const sel=el.selectionStart, before=(el.value||"").length;
      el.value=Number(raw).toLocaleString("ja-JP");
      const after=(el.value||"").length, diff=after-before;
      try{ el.setSelectionRange((sel||after)+diff,(sel||after)+diff);}catch(_){}
    }

    /* ===== è¨ˆç®— ===== */
    const priceBase=$("priceBase"), discountSel=$("discountSelect"), customRow=$("customRow"),
          discountCustom=$("discountCustom"), offAmount=$("offAmount"), priceAfter=$("priceAfter"),
          priceSell=$("priceSell"), resetBtn=$("resetBtn"), janCode=$("janCode"),
          clearBase=$("clearBase"), clearSell=$("clearSell"), clearJan=$("clearJan"),
          pointsUse=$("pointsUse"), couponYen=$("couponYen"),
          profitBig=$("profitBig"), profitRateEl=$("profitRate");

    const jpy=n=>!isFinite(n)?"Â¥0":"Â¥"+Math.round(n).toLocaleString("ja-JP");
    const num=v=>{ const n=parseFloat(String(v).replace(/,/g,"")); return isFinite(n)?n:0; };
    const currentRate=()=> (discountSel.value==="custom" ? Math.max(0, num(discountCustom.value)||0) : num(discountSel.value));

    function clampNonNegative(el){
      let v=Math.max(0, num(el.value));
      const formatted = v ? v.toLocaleString("ja-JP") : "";
      if(el.value!==formatted) el.value=formatted;
      return v;
    }

    function recalc(){
      const base = Math.max(0, num(priceBase.value));
      const rate = Math.max(0, Math.min(100, currentRate()));
      const offByRate  = base * (rate/100);

      // ãƒã‚¤ãƒ³ãƒˆãƒ»ã‚¯ãƒ¼ãƒãƒ³
      const points = clampNonNegative(pointsUse);
      const coupon = clampNonNegative(couponYen);

      // å‰²å¼•é¡ï¼ å‰²å¼•ï¼ˆï¼…ï¼‰ï¼‹ ãƒã‚¤ãƒ³ãƒˆ ï¼‹ ã‚¯ãƒ¼ãƒãƒ³
      const totalOff = offByRate + points + coupon;
      offAmount.textContent = jpy(totalOff);

      // å‰²å¼•å¾Œã®ä»•å…¥ã‚Œï¼ˆãƒã‚¤ãƒ³ãƒˆãƒ»ã‚¯ãƒ¼ãƒãƒ³ã‚‚åæ˜ ï¼‰
      let after = base - totalOff;
      if(after < 0) after = 0;
      priceAfter.textContent= jpy(after);

      // å£²ä¾¡
      const sell = Math.max(0, num(priceSell.value));

      // åˆ©ç›Šï¼ è²·å–ä¾¡æ ¼ âˆ’ å‰²å¼•å¾Œã®ä»•å…¥ã‚Œ
      const pf = sell - after;
      profitBig.textContent = jpy(pf);
      profitBig.style.color = pf>=0 ? "var(--ok)" : "var(--bad)";

      // åˆ©ç›Šç‡ï¼ åˆ©ç›Š / å‰²å¼•å¾Œã®ä»•å…¥ã‚Œ
      const pr = after>0 ? (pf/after*100) : 0;
      profitRateEl.textContent = "åˆ©ç›Šç‡ " + (isFinite(pr)?pr.toFixed(1):"0.0") + "%";
    }

    function updateJanLinks(){
      const jan=(janCode.value||"").trim();
      document.querySelectorAll(".bb-linkbtn[data-type='support']").forEach(a=>{
        const base=a.getAttribute("data-base")||""; a.href = jan ? (base+encodeURIComponent(jan)) : base;
      });
    }

    // åˆæœŸ
    recalc(); updateJanLinks();

    // å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã‚«ãƒ³ãƒæ•´å½¢ï¼‹å†è¨ˆç®—ï¼‰
    [priceBase, priceSell, pointsUse, couponYen].forEach(el=>{
      el && el.addEventListener("input", ()=>{ fmtInput(el); recalc(); });
    });
    [discountCustom, janCode].forEach(el=> el && el.addEventListener("input", ()=>{ recalc(); updateJanLinks(); }));

    // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³
    clearBase && clearBase.addEventListener("click", ()=>{ priceBase.value=""; recalc(); });
    clearSell && clearSell.addEventListener("click", ()=>{ priceSell.value=""; recalc(); });
    clearJan  && clearJan.addEventListener("click",  ()=>{ janCode.value=""; updateJanLinks(); });

    // å‰²å¼•é¸æŠ
    discountSel && discountSel.addEventListener("change", ()=>{
      customRow.style.display=(discountSel.value==="custom")?"grid":"none";
      if(discountSel.value!=="custom"){ discountCustom.value=""; }
      recalc();
    });

    // ãƒªã‚»ãƒƒãƒˆ
    resetBtn && resetBtn.addEventListener("click", ()=>{
      priceBase.value=""; priceSell.value="";
      pointsUse.value=""; couponYen.value="";
      discountSel.value="0"; discountCustom.value=""; customRow.style.display="none";
      recalc();
    });

    /* ===== æ‰‹å‹•æ¤œç´¢ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆç¶­æŒï¼‰ ===== */
    const modal=$("janModal"), modalTitle=$("modalTitle"), modalBody=$("modalBody"),
          modalCopyGo=$("modalCopyGo"), modalGo=$("modalGo"), modalClose=$("modalClose");
    document.querySelectorAll(".bb-linkbtn[data-type='manual']").forEach(a=>{
      a.addEventListener("click",(e)=>{ e.preventDefault();
        const site=a.getAttribute("data-name")||"ã‚µã‚¤ãƒˆ";
        modalTitle.textContent=site+"ã¸ç§»å‹•";
        modalBody.textContent=site+"ã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªèº«ã§JANã‚’æ¤œç´¢ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚";
        modal.classList.add("show"); modal.setAttribute("aria-hidden","false");
        modalCopyGo.onclick=async ()=>{ try{ await navigator.clipboard.writeText((janCode.value||"").trim()); }catch(_){} window.open(a.href,"_blank","noopener"); modalClose.click(); };
        modalGo.onclick=()=>{ window.open(a.href,"_blank","noopener"); modalClose.click(); };
      });
    });
    modalClose&&modalClose.addEventListener("click", ()=>{ modal.classList.remove("show"); modal.setAttribute("aria-hidden","true"); });
    modal&&modal.addEventListener("click",(e)=>{ if(e.target===modal) modalClose.click(); });

    /* ===== ã‚¹ã‚­ãƒ£ãƒŠï¼ˆç¶­æŒï¼šhtml5-qrcodeâ†’BarcodeDetectorâ†’ZXingï¼3å›ä¸€è‡´ï¼‹åŠ¹æœéŸ³ï¼‰ ===== */
    const scanWrap=$("scanWrap"), h5Region=$("h5Region"), stage=$("stage"),
          scanStart=$("scanStart"), scanStop=$("scanStop"), scanClose=$("scanClose"),
          newtabBtn=$("newtabBtn"), diagBtnEl=$("diagBtn"), scanMsg=$("scanMsg"), scanLine=$("scanLine"), beep=$("beep");
    const photoInput=$("photoInput");
    let html5q=null, h5Loaded=false, scanning=false;
    let mediaStream=null, zxingReader=null, roiCanvas=null, roiCtx=null, videoEl=null, lineId=null;

    function loadHtml5(){ if(h5Loaded) return Promise.resolve();
      const c=[location.origin+"/assets/html5-qrcode.min.js","https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.10/minified/html5-qrcode.min.js","https://unpkg.com/html5-qrcode@2.3.10/minified/html5-qrcode.min.js","https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.10/html5-qrcode.min.js"];
      return loadScriptChain(c).then(()=>{ h5Loaded=true; });
    }
    function loadZXing(){ if(window.ZXing) return Promise.resolve();
      const c=[location.origin+"/assets/zxing.min.js","https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/umd/index.min.js","https://unpkg.com/@zxing/library@0.19.1/umd/index.min.js","https://cdnjs.cloudflare.com/ajax/libs/zxing/0.19.1/zxing.min.js"];
      return loadScriptChain(c);
    }

    function animateScanline(){
      const H=stage.getBoundingClientRect().height;
      const center=H*0.5, amp=H*0.40, speed=1800; let t0=null;
      function step(ts){ if(!scanWrap.classList.contains("show")) return; if(!t0) t0=ts;
        const phase=((ts-t0)%speed)/speed; const y=center + Math.sin(phase*2*Math.PI)*amp*0.5;
        scanLine.style.transform="translate3d(0,"+y+"px,0)"; lineId=requestAnimationFrame(step);
      }
      cancelAnimationFrame(lineId); lineId=requestAnimationFrame(step);
    }
    function showScanUI(){ scanWrap.classList.add("show"); scanWrap.setAttribute("aria-hidden","false"); animateScanline(); }
    function hideScanUI(){ scanWrap.classList.remove("show"); scanWrap.setAttribute("aria-hidden","true"); cancelAnimationFrame(lineId); }

    scanStart&&scanStart.addEventListener("click", ()=>{ showScanUI(); startEmbeddedScan(); });

    let lastVal="", sameCount=0;
    function confirm3(code){ const v=String(code||"").replace(/\D/g,""); if(v.length<8||v.length>14) return null; sameCount=(v===lastVal)?sameCount+1:1; lastVal=v; return sameCount>=3?v:null; }
    function beepOk(){ try{ beep.currentTime=0; beep.play().catch(()=>{}); }catch(_){ } try{ navigator.vibrate&&navigator.vibrate(60);}catch(_){ } }

    function startEmbeddedScan(){
      scanMsg.textContent = inIframe ? "â€» åŸ‹ã‚è¾¼ã¿è¡¨ç¤ºã¯æ‹’å¦ã•ã‚Œã‚„ã™ã„ã§ã™ã€‚æ–°è¦ã‚¿ãƒ–ã‚¹ã‚­ãƒ£ãƒ³ãŒã‚ˆã‚Šç¢ºå®Ÿã§ã™ã€‚" : "ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¦ã„ã¾ã™â€¦";
      sameCount=0; lastVal="";
      loadHtml5().then(()=>{
        if(!window.Html5Qrcode) throw 0;
        if(!html5q) html5q=new Html5Qrcode(h5Region,{verbose:false});
        const cfg={ fps:22, qrbox:(w,h)=>({width:Math.floor(w*0.88), height:Math.floor(h*0.40)}),
          aspectRatio:16/9, showTorchButtonIfSupported:true,
          experimentalFeatures:{useBarCodeDetectorIfSupported:true},
          formatsToSupport:[ Html5QrcodeSupportedFormats.EAN_13,Html5QrcodeSupportedFormats.EAN_8,Html5QrcodeSupportedFormats.UPC_A,Html5QrcodeSupportedFormats.UPC_E,Html5QrcodeSupportedFormats.CODE_128,Html5QrcodeSupportedFormats.ITF ] };
        const onSuccess=t=>{ const ok=confirm3(t); if(ok) finalizeScan(ok); };
        return html5q.start({facingMode:{ideal:"environment"}}, cfg, onSuccess, ()=>{});
      }).then(()=>{ scanning=true; scanMsg.textContent="èª­ã¿å–ã‚Šä¸­â€¦ï¼ˆèµ¤ç·šã«åˆã‚ã›ã¦ãã ã•ã„ï¼‰"; })
        .catch(()=>{ if("BarcodeDetector" in window) startNativeDetector(); else startZXingFallback(); });
    }
    function stopEmbeddedScan(close){
      try{ if(scanning && html5q){ html5q.stop().then(()=>html5q.clear()).catch(()=>{}); } }catch(_){}
      scanning=false;
      if(mediaStream){ try{ mediaStream.getTracks().forEach(t=>t.stop()); }catch(_){ } mediaStream=null; }
      if(zxingReader){ try{ zxingReader.reset(); }catch(_){ } zxingReader=null; }
      if(videoEl){ try{ videoEl.pause(); videoEl.srcObject=null; videoEl.remove(); }catch(_){ } videoEl=null; }
      if(roiCanvas){ try{ roiCanvas.remove(); }catch(_){ } roiCanvas=null; roiCtx=null; }
      if(close) hideScanUI();
    }
    scanStop&&scanStop.addEventListener("click", ()=>stopEmbeddedScan(false));
    scanClose&&scanClose.addEventListener("click", ()=>stopEmbeddedScan(true));

    function finalizeScan(code){ janCode.value=code; updateJanLinks(); try{ beepOk(); }catch(_){ } stopEmbeddedScan(true); }

    function startNativeDetector(){
      scanMsg.textContent="ãƒã‚¤ãƒ†ã‚£ãƒ–æ¤œå‡ºã§èµ·å‹•ä¸­â€¦";
      navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ideal:"environment"}, width:{ideal:1280}, height:{ideal:720}, focusMode:"continuous" }, audio:false })
      .then(stream=>{ mediaStream=stream; videoEl=document.createElement("video"); videoEl.setAttribute("playsinline",""); videoEl.setAttribute("autoplay",""); videoEl.muted=true;
        h5Region.innerHTML=""; h5Region.appendChild(videoEl); videoEl.srcObject=mediaStream; return videoEl.play(); })
      .then(()=>{ roiCanvas=document.createElement("canvas"); roiCtx=roiCanvas.getContext("2d",{willReadFrequently:true}); roiCanvas.style.display="none"; h5Region.appendChild(roiCanvas);
        const det=new window.BarcodeDetector({formats:['ean_13','ean_8','upc_a','upc_e','code_128','itf']});
        (function loop(){ if(!mediaStream) return; const W=videoEl.videoWidth,H=videoEl.videoHeight; if(!W||!H){ requestAnimationFrame(loop); return; }
          const bh=Math.floor(H*0.40), y=Math.floor((H-bh)/2); roiCanvas.width=W; roiCanvas.height=bh;
          roiCtx.filter="contrast(1.35) brightness(1.08)"; roiCtx.drawImage(videoEl,0,y,W,bh,0,0,W,bh);
          det.detect(roiCanvas).then(cs=>{ if(cs&&cs.length){ const ok=confirm3((cs[0].rawValue||"")); if(ok){ finalizeScan(ok); return; } } requestAnimationFrame(loop); })
            .catch(()=>{ requestAnimationFrame(loop); });
        })(); scanMsg.textContent="èª­ã¿å–ã‚Šä¸­â€¦"; })
      .catch(()=>startZXingFallback());
    }

    function startZXingFallback(){
      scanMsg.textContent="ZXingãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§èµ·å‹•ä¸­â€¦";
      loadZXing().then(()=>navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ideal:"environment"}, width:{ideal:1280}, height:{ideal:720} }, audio:false }))
      .then(stream=>{ mediaStream=stream; videoEl=document.createElement("video"); videoEl.setAttribute("playsinline",""); videoEl.setAttribute("autoplay",""); videoEl.muted=true;
        h5Region.innerHTML=""; h5Region.appendChild(videoEl); videoEl.srcObject=mediaStream; return videoEl.play(); })
      .then(()=>{ const ZX=window.ZXing; const hints=new Map(); hints.set(ZX.DecodeHintType.TRY_HARDER,true); hints.set(ZX.DecodeHintType.ALSO_INVERTED,true);
        hints.set(ZX.DecodeHintType.POSSIBLE_FORMATS,[ZX.BarcodeFormat.EAN_13,ZX.BarcodeFormat.EAN_8,ZX.BarcodeFormat.UPC_A,ZX.BarcodeFormat.UPC_E,ZX.BarcodeFormat.CODE_128,ZX.BarcodeFormat.ITF]);
        zxingReader=new ZX.BrowserMultiFormatReader(hints,400);
        return zxingReader.listVideoInputDevices().then(devs=>{ let rear=null; if(devs&&devs.length){ for(let i=0;i<devs.length;i++) if(/back|rear|environment|å¤–å´|èƒŒé¢|world/i.test(devs[i].label)){ rear=devs[i]; break; } if(!rear) rear=devs[devs.length-1]; }
          zxingReader.decodeFromVideoDevice(rear?rear.deviceId:undefined, videoEl, r=>{ if(r&&r.text){ const ok=confirm3(r.text); if(ok) finalizeScan(ok); } });
          scanMsg.textContent="èª­ã¿å–ã‚Šä¸­â€¦"; });
      }).catch(()=>{ scanMsg.textContent="ã‚«ãƒ¡ãƒ©é–‹å§‹ã«å¤±æ•—ã€‚HTTPS/æ¨©é™ã‚’ã”ç¢ºèªãã ã•ã„ã€‚"; });
    }

    /* ===== Bluetooth HID ã‚¹ã‚­ãƒ£ãƒŠå—ä¿¡ï¼ˆç¶­æŒï¼‰ ===== */
    const hidWrap=$("hidWrap"), hidDisplay=$("hidDisplay"), hidSink=$("hidSink"),
          hidStart=$("hidStart"), hidStop=$("hidStop"), hidClose=$("hidClose"), hidClear=$("hidClear");

    let hidBuf="", hidTimer=null, hidPrevLen=0;

    function showHid(){ hidWrap.classList.add("show"); hidWrap.setAttribute("aria-hidden","false"); hidDisplay.textContent=""; hidBuf=""; hidPrevLen=0;
      setTimeout(()=>{ try{ hidSink.value=""; hidSink.focus({preventScroll:true}); }catch(_){ } }, 0);
    }
    function hideHid(){ hidWrap.classList.remove("show"); hidWrap.setAttribute("aria-hidden","true"); clearTimeout(hidTimer); hidTimer=null; }
    function updateDisp(){ hidDisplay.textContent = hidBuf || ""; }
    function finishIfValid(){
      const v=hidBuf.replace(/\D/g,"");
      if(v.length>=8 && v.length<=14){
        janCode.value=v; updateJanLinks(); try{ $("beep").currentTime=0; $("beep").play().catch(()=>{});}catch(_){ } try{ navigator.vibrate&&navigator.vibrate(60);}catch(_){}
        hideHid();
      }else{ updateDisp(); }
    }
    function scheduleIdleFinish(){ clearTimeout(hidTimer); hidTimer=setTimeout(()=>{ finishIfValid(); }, 220); }

    hidStart && hidStart.addEventListener("click", showHid);
    hidClose && hidClose.addEventListener("click", hideHid);
    hidStop  && hidStop.addEventListener("click", ()=>{ finishIfValid(); });
    hidClear && hidClear.addEventListener("click", ()=>{ hidBuf=""; hidPrevLen=0; hidSink.value=""; updateDisp(); setTimeout(()=>hidSink.focus(),0); });

    hidSink && hidSink.addEventListener("input", ()=>{
      const s=hidSink.value||""; const inc=s.slice(hidPrevLen); hidPrevLen=s.length;
      if(inc){ const digits=inc.replace(/[^\d]/g,""); if(digits){ hidBuf += digits; updateDisp(); scheduleIdleFinish(); } }
    });
    hidSink && hidSink.addEventListener("keydown",(e)=>{
      const k=e.key; if(k==="Enter"||k==="Tab"){ e.preventDefault(); finishIfValid(); }
      else if(k==="Escape"){ e.preventDefault(); hideHid(); }
    });

    /* ===== æ–°è¦ã‚¿ãƒ–å—ä¿¡ãƒ»ç’°å¢ƒè¨ºæ–­ãƒ»ç”»åƒã‹ã‚‰èª­ã¿å–ã‚‹ï¼ˆç¶­æŒï¼‰ ===== */
    window.addEventListener("message",(e)=>{ const d=e&&e.data; if(!d||d.type!=="jan-scanned") return; const v=String(d.value||"").replace(/\D/g,"");
      if(v && v.length>=8 && v.length<=14){ janCode.value=v; updateJanLinks(); try{ $("beep").currentTime=0; $("beep").play().catch(()=>{});}catch(_){ } scanWrap.classList.remove("show"); scanWrap.setAttribute("aria-hidden","true"); } });

    $("diagBtn")&&$("diagBtn").addEventListener("click", ()=>{ const secure=location.protocol==="https:"||["localhost","127.0.0.1"].includes(location.hostname);
      $("scanMsg").textContent=[(secure?"âœ…":"âŒ")+" HTTPS/localhost",(navigator.mediaDevices?"âœ…":"âŒ")+" mediaDevicesã‚ã‚Š",(inIframe?"âš ":"âœ…")+" "+(inIframe?"iframeè¡¨ç¤º":"ãƒˆãƒƒãƒ—è¡¨ç¤º")].join(" / "); });

    function ensureHtml5(){ return loadHtml5().catch(()=>{}); }
    const photoInputEl=$("photoInput");
    photoInputEl&&photoInputEl.addEventListener("change",(e)=>{
      const file=e.target.files&&e.target.files[0]; if(!file) return;
      const url=URL.createObjectURL(file), img=new Image();
      img.onload=function(){
        ensureHtml5().then(()=>{ if(window.Html5Qrcode){ return Html5Qrcode.scanFile(img,true,[ Html5QrcodeSupportedFormats.EAN_13,Html5QrcodeSupportedFormats.EAN_8,Html5QrcodeSupportedFormats.UPC_A,Html5QrcodeSupportedFormats.UPC_E,Html5QrcodeSupportedFormats.CODE_128,Html5QrcodeSupportedFormats.ITF ])
          .then(r=>{ const v=String(r||"").replace(/\D/g,""); if(v){ janCode.value=v; updateJanLinks(); try{ $("beep").currentTime=0; $("beep").play().catch(()=>{});}catch(_){ } } }).catch(()=>{}); } })
        .then(()=>{ if(!window.ZXing) return loadZXing(); })
        .then(()=>{ if(window.ZXing){ const reader=new ZXing.BrowserMultiFormatReader(); return reader.decodeFromImage(img).catch(()=>null).then(res=>{ if(res&&res.text){ const v=res.text.replace(/\D/g,""); if(v){ janCode.value=v; updateJanLinks(); try{ $("beep").currentTime=0; $("beep").play().catch(()=>{});}catch(_){ } } } else { alert("ç”»åƒã‹ã‚‰èª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ãŒã¯ã£ãã‚Šå†™ã£ãŸå†™çœŸã‚’ãŠè©¦ã—ãã ã•ã„ã€‚"); } }); }
               else { alert("ç”»åƒã‹ã‚‰èª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚"); } })
        .finally(()=>{ URL.revokeObjectURL(url); e.target.value=""; });
      }; img.src=url;
    });

  })();
  </script>
</div></div>
